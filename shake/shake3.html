<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>摇一摇</title>
    <meta name="format-detection" content="telephone=no" />
    <meta name="format-detection" content="email=no" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <script type='text/javascript' src='zepto.min.js' charset='utf-8'></script>
    <link rel="stylesheet" href="style.css">
    <script>
        (function () {
            document.addEventListener('DOMContentLoaded', function () {
                var html = document.documentElement;
                var windowWidth = html.clientWidth;
                if(windowWidth < 750) {
                    html.style.fontSize = windowWidth / 7.5 + 'px';
                } else {
                    html.style.fontSize = '80px';
                }

            }, false);
        })();
    </script>
</head>
<body>
<div class="container">
    <div class="banner">
        <span class="price">奖品:价值5600元精品挂葫芦</span>
    </div>
    <!--  -->
    <div class="info">
        <img class="header" src="header.png">
        <!--  -->
        <div class="tip-show">
            <div class="text">童话光年，欢迎您！</div>
            <div class="text">摇一摇，赢大奖！</div>
        </div>
        <!--  -->
        <div class="tip-hide">
            <div class="text">童话光年，继续加油！</div>
            <div class="text">您已摇<span id="all">0</span>次，排名<span id="range">0</span>名</div>
        </div>
    </div>
    <!--  -->
    <div class="circle">
        <div class="hand"></div>
        <div class="deng"></div>
    </div>
</div>

<script type="text/javascript" src="shake.js"></script>
<script type="text/javascript">
    window.onload = function() {
        //灯光效果
        var light = 0;
        setInterval(function(){
            light += 500;
            $('.deng').addClass('deng2');
            if(light%1000 == 0) {
                $('.deng').removeClass('deng2');
            }
        }, 500);
        //
        var count = 0;
        var myShakeEvent = new Shake({
            threshold: 12,
            timeout: 150
        });
        //摇动事件回调
        function shakeEventDidOccur () {
            count++;
            $('#all').html(count);
        }

        //计数计时, 提交计时
        var left = 60, post = left;

        //TODO 摇一摇开关
        var flag = false;
        var flag_timer = setInterval(deal, 500);

        function getFlag() {
            flag = true;
        }

        function deal() {
            getFlag();
            if(flag) {
                //禁止获取摇一摇状态
                clearInterval(flag_timer);
                //摇一摇功能
                $('.tip-show').hide();
                $('.tip-hide').show();
                $('.hand').addClass('shake');

                myShakeEvent.start();
                window.addEventListener('shake', shakeEventDidOccur, false);

                var timer = setInterval(function(){
                    if(left > 0) {
                        left--;
                    } else {
                        clearInterval(timer);
                        $('.hand').removeClass('shake');
                        myShakeEvent.stop();
                    }
                }, 1000);

                //服务端交互
                var send = setInterval(function(){
                    if(post > 0) {
                        post -= 2;
                        $('#range').html(post);
                    } else {
                        clearInterval(send);
                    }
                }, 2000);

                //恢复获取摇一摇状态
                setTimeout(function(){
                    flag_timer = setInterval(deal, 500);
                }, 60000);
            } else {
                return;
            }
        }
    };
</script>
</body>
</html>